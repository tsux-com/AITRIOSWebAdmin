
# Webアプリケーション仕様書

## 概要
このドキュメントは、FastAPIを使用したWebアプリケーションの仕様書です。

WEBアプリ　管理画面を介して外部APIを呼び出し、デバイスの推論開始および停止する機能。

---

## アプリケーション構成

```
- web/
    - app.py
    - access_token.py
    - api_services/
        - service.py
    - templates/
        - index.html
- server/
    - webapp.py
    - image/
    - meta/
- .env
```

---

## 各スクリプトの詳細

### 1. server/webapp.py
このスクリプトは、FastAPIを使用して、メタデータファイルと画像ファイルをアップロードし、指定されたパスに保存するためのAPIを提供します。

- **機能**:
  - 画像ファイルおよびメタデータファイルの保存
  - リクエストのロギング

#### 詳細説明
- **ログの設定**: すべてのHTTPリクエストを記録するためのミドルウェアを追加。
- **メタデータの保存**: `PUT /meta/{filename}` エンドポイントを使用してメタデータを保存。
- **画像の保存**: `PUT /image/{filename}` エンドポイントを使用して画像を保存。

---

### 2. web/app.py
このスクリプトは、ユーザーがAPIを開始・停止するためのUIを提供します。Jinja2テンプレートを使用してHTMLをレンダリングし、API呼び出しを行う。

- **機能**:
  - HTMLテンプレートのレンダリング
  - API開始・停止操作

#### 詳細説明
- **トークン管理**: 各API呼び出し時に、`load_access_token()` を使用してトークンをロード。
- **API呼び出し**: ユーザーがボタンをクリックすると、外部APIに対してデバイスのデータ収集開始または停止リクエストが送信される。

---

### 3. web/access_token.py
このスクリプトは、外部APIへのアクセスに必要なトークンを取得し、管理します。

トークンは一度取得するとテキストファイル( access_token.txt )に保存され、必要に応じて再利用されます。

- **機能**:
  - OAuth2クライアント認証によるアクセストークンの取得
  - トークンの有効期限の管理と再取得

#### 詳細説明
- **トークン取得**: `get_access_token()` 関数を使用して、外部APIから新しいトークンを取得。
- **トークンロード**: トークンはファイルからロードされ、有効期限が切れている場合は再取得される。

---

### 4. api_services/service.py
推論開始・停止するために外部APIに対してPOSTリクエストを送信します。

- **機能**:
  - 外部APIにデバイスのデータ収集開始・停止リクエストを送信
  - APIレスポンスの処理

#### 詳細説明
- **API呼び出し**:
  - `post_collectstart_to_api()` は推論開始リクエストを送信。
  - `post_collectstop_to_api()` は推論停止リクエストを送信。
- **エラーハンドリング**: リクエスト失敗時や無効なJSONレスポンス時には適切なエラーメッセージを返却。

---

## 環境変数 (`.env` ファイル)
クライアントIDとクライアントシークレットを環境変数として管理しています。

`.env` ファイルから以下の環境変数が読み込まれます。

- `CLIENT_ID`: クライアントID
- `CLIENT_SECRET`: クライアントシークレット

---

## テンプレートファイル (`index.html`)
HTMLファイルは、Jinja2テンプレートを使用してレンダリングされ、API呼び出しを行うためのボタンが配置されています。

---
## command parameter

"StorageName": ここに実際のIPアドレス (例: "192.168.x.x") を入力

"StorageNameIR": ここに実際のIPアドレス (例: "192.168.x.x") を入力

---
## 実行コマンド

HTTP Server　の立ち上げ	：
```

uvicorn webapp:app_ins --reload --host 192.168.0.23 --port 8080 --no-access-log

```

webアプリ　の立ち上げ		：　

```

.\venv\Scripts\Activate

```

```

uvicorn "app:app --reload --port 8000"

```